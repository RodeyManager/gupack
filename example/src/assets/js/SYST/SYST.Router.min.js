/*
* SYST.Router.js v 1.0
* Copyright  2016, Rodey Luo
* Released under the MIT License.
* Date Tue Dec 06 2016 15:45:14 GMT+0800 (中国标准时间)
*/
!function(t){var e=window.location,i=e.hash,n=("pushState"in history,"replaceState"in history,/\((.*?)\)/g),r=/(\(\?)?:\w+/g,s=/\*\w+/g,o=/[\-{}\[\]+?.,\\\^$|#\s]/g,a=function(){},h=function(t){return t.replace(/[#!]/gi,"").split("?")[0]},c=function(){this.__instance_SYST__="SYST Router",this.__Name__="SYST Router"};t.Router=function(){var e=t.extendClass(arguments,c);return e._initialize(),e},t.R=c.prototype={$:t.$,_initialize:function(){if(this._reset(),t.V.isObject(this.routes)&&this.routes!={}){var e=this.routes;for(var i in e)this._initRouters(i,e[i]);this.start()}},_reset:function(){this._cache=this._cache||{},this._stateCache=this._stateCache||[],this.routes=this.routes||null,this.container=this.container||"body",this.router=this.router||null,this.params=this.params||null,this.isRender=this.isRender||!1},_initRouters:function(e,i){t.V.isString(i)&&this[i]&&(i=this[i]),this._cache[e]=i},start:function(){var t=this.redirectTo;if(i&&""!==i){var e=h(i);this.switcher(e)}else t&&this._updateHash(t);return this._changeStart(),this},stop:function(){this._changeStop()},when:function(e,i){return t.V.isEmpty(e)?void 0:(t.V.isObject(i)?this._cache[e]=i:t.V.isFunction(i)&&(this._cache[e]=i.apply(this)),this)},switcher:function(e,i){if(this._cache&&{}!==this._cache){var n=this._getRouter(e),i=i||n.router;return i&&(this._cache[e]=i),this.params=t.T.params(null,window.location.href),this._exec(e),this}},renderBefore:a,rendering:a,rendered:a,getRouter:function(t){return this._getRouter(t)},_getRouter:function(t){if(this._cache&&this._cache!=={}){var e,i,n,r;for(n in this._cache)if(r=this._routeToRegExp(n),r.test(t)){i=n,e=this._cache[n];break}return{routeKey:i,router:e}}},_routeToRegExp:function(t){return t=t.replace(o,"\\$&").replace(n,"(?:$1)?").replace(r,function(t,e){return e?t:"([^/?]+)"}).replace(s,"([^?]*?)"),new RegExp("^"+t+"(?:\\?([\\s\\S]*))?$")},_extractParameters:function(e,i,n){var r=e.exec(n).slice(1),s=e.exec(i).slice(1),o=[],a={};return t.V.isArray(r)&&r.length>0&&t.T.each(r,function(t){o.push(t?decodeURIComponent(t):null)}),t.V.isArray(s)&&s.length>0&&t.T.each(s,function(t,e){t&&(a[t.replace(/^[^\w]|[^\w]$/i,"")]=o[e])}),{paramsObject:a,params:o}},_exec:function(i){var n=this._getRouter(i),r=n.router,s=n.routeKey;if(!r)return this;this.router=r,this.router.route=s,t.V.isRegExp(s)||(i=this._routeToRegExp(s));var o=h(e.hash),a=this._extractParameters(i,s,o),c=a.paramsObject;a.params;this.params=t.extend(this.params,c),this.router.params=this.params,this._onReady(),this._execRouter()},_execRouter:function(){var t=this,e=this.router;if(e){var i=e.container||this.container||"body";e.template?this._template(e.template,i,function(e){t._execMAction(e),t._onRender()}):t._execMAction()}},_execMAction:function(e){this.tpl=e,this.router.tpl=e;var i=this.router,n=i.view,r=i.action;t.V.isFunction(i)&&i.apply(this),r&&t.V.isFunction(r)&&r.call(this,n,this.params,e)},_changeStart:function(){this._changeStop(),window.addEventListener("hashchange",t.T.proxy(this,"_changeHandler"),!1)},_changeStop:function(){window.removeEventListener("hashchange",t.T.proxy(this,"_changeHandler"),!1)},_changeHandler:function(t){var e,i=this;t.newURL?this.newURL="#"+t.newURL.split("#")[1]:this.newURL="#"+location.hash.split("#")[1];var n=h(this.newURL);n&&(e=this._getRouter(n)),e&&e.router&&this._onDestroy(function(){i.router=e,i.switcher(n)})},_template:function(e,i,n){function r(e){t.V.isFunction(s.rendered)&&s.rendered.apply(s),n&&t.V.isFunction(n)&&n.call(s,e)}var s=this;this.container=t.Dom(i),t.V.isFunction(s.renderBefore)&&s.renderBefore.apply(s);var o=/^(load[\@|\!|\#|\>])+?/gi;o.test(e)?(e=e.replace(o,""),this.container.load(e,function(t){r(t)},function(t){throw new Error("load template is failed!")})):r(e)},_onReady:function(){var e,i=this.router;i&&t.V.isFunction(i.onReady)&&i.onReady.call(this),e=i.view,e&&(e.router=i,e.init&&e.init(i),e.offEvent().onEvent())},_onRender:function(){var e=this.router,i=this.tpl;(e.data||e.isRender||this.isRender)&&(i=t.T.render(i,e.data)),this.container.html(i),this.tpl=i,this.router.tpl=i,t.V.isFunction(e.onRender)&&e.onRender.call(this,i)},_onDestroy:function(e){var i,n,r,s,o=this.router;if(t.V.isObject(o))if(n=o.onDestroy,r=o.route,s=o._destroyState,i=o.view,i&&(o.view=null,delete o.view,i.offEvent()),t.V.isFunction(n)){var a=n.apply(this);a!==!1?(o._destroyState=!0,t.V.isFunction(e)&&e.apply(this)):(o._destroyState=!1,this._updateHash(r))}else t.V.isFunction(e)&&e.apply(this);else t.V.isFunction(e)&&e.apply(this)},_updateHash:function(t){window.location.hash="#!"+t.replace(/^#!/i,"")}}}(SYST);